name: Sync EmailJS Contacts

on:
  schedule:
    # Run every 6 hours to keep subscribers in sync
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    paths:
      - 'tools/sync-emailjs-contacts.js'
      - '.github/workflows/sync-emailjs.yml'
      - 'data/subscribers.json'

jobs:
  sync-contacts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Check for EmailJS CSV file
        id: check_csv
        run: |
          if [ -f "emailjs-contacts.csv" ]; then
            echo "csv_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found emailjs-contacts.csv - will sync contacts"
          else
            echo "csv_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No CSV file found"
            echo ""
            echo "üìã To enable automatic sync (EmailJS as single source of truth):"
            echo "   1. Go to EmailJS Dashboard ‚Üí Contacts"
            echo "   2. Click 'Export to CSV'"
            echo "   3. Save as 'emailjs-contacts.csv' in repository root"
            echo "   4. Commit and push the file"
            echo "   5. This workflow will automatically sync every 6 hours"
            echo ""
            echo "üí° After initial setup, just export CSV periodically and push to repo"
            echo "   The sync will happen automatically - no recompilation needed!"
          fi
      
      - name: Sync Contacts from EmailJS CSV
        if: steps.check_csv.outputs.csv_exists == 'true'
        env:
          EMAILJS_PRIVATE_KEY: ${{ secrets.EMAILJS_PRIVATE_KEY }}
          EMAILJS_SERVICE_ID: ${{ secrets.EMAILJS_SERVICE_ID }}
        run: |
          echo "üîÑ Syncing contacts from EmailJS (single source of truth)..."
          node tools/sync-emailjs-contacts.js emailjs-contacts.csv
          echo "‚úÖ Sync completed - subscribers.json updated"
      
      - name: No CSV - Skip sync (normal if CSV not in repo)
        if: steps.check_csv.outputs.csv_exists == 'false'
        run: |
          echo "‚ÑπÔ∏è  Skipping sync - emailjs-contacts.csv not found in repository"
          echo "üìù This is normal if you haven't set up the CSV file yet"
          echo "üí° Use newsletter admin panel CSV import for manual sync"
      
      - name: Commit and push changes
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/subscribers.json build/data/subscribers.json
          git diff --staged --quiet || git commit -m "Auto-sync: Update subscribers from EmailJS contacts [skip ci]"
          git push
        continue-on-error: true

