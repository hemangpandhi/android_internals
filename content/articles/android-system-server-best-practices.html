<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Server: Best Practices and Optimization - Android Internals</title>
  <meta name="description" content="Development guidelines, threading best practices, memory management, and security considerations for system_server development.">
  <meta name="keywords" content="Android, Internals, System Architecture, development, programming">
  <link rel="stylesheet" href="../assets/css/styles.css?v=17">
  <link rel="icon" href="../assets/images/android_logo.PNG" type="image/png">
  <link rel="manifest" href="../assets/manifest.json">
  <meta name="theme-color" content="#3ddc84">
  
  <!-- Mermaid.js for diagram rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.7.0/dist/mermaid.min.js"></script>
  <style>
    .mermaid-diagram {
      margin: 1rem 0;
      padding: 0.75rem 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      position: relative;
      overflow: visible !important;
      z-index: 1;
      /* Scroll margin to account for fixed navigation bar (80px height) */
      scroll-margin-top: 100px;
      /* Ensure container can expand to show full diagram - no height constraints */
      min-height: auto !important;
      height: auto !important;
      max-height: none !important;
      /* Ensure content is not clipped */
      overflow-x: visible;
      overflow-y: visible;
    }
    
    .mermaid-diagram.zoomed {
      /* Ensure zoomed diagrams can scroll horizontally and vertically */
      overflow-x: auto !important;
      overflow-y: auto !important;
      max-width: 100%;
      z-index: 1040 !important;
      position: relative;
    }
    
    .mermaid {
      text-align: center;
      display: block;
      width: 100%;
      min-height: auto;
      height: auto;
      transition: transform 0.3s ease;
      cursor: grab;
      margin: 0;
      padding: 0;
      display: block;
    }
    
    .mermaid svg {
      display: block !important;
      margin: 0 auto !important;
      max-width: 100% !important;
      width: 100% !important;
      height: auto !important;
      min-height: auto !important;
      max-height: none !important;
      /* Ensure SVG can expand to show full content - critical for Mermaid 10.7.0 */
      overflow: visible !important;
      /* Remove any height constraints that might clip content */
      box-sizing: border-box;
    }
    
    /* Specific styling for sequence diagrams to reduce vertical spacing */
    .mermaid-diagram.sequence-diagram-container {
      padding: 0.4rem 1rem !important;
    }
    
    /* Alternative CSS selector for sequence diagrams */
    .mermaid-diagram:has(svg g.actor),
    .mermaid-diagram:has(svg g.note),
    .mermaid-diagram:has(svg g.activation) {
      padding: 0.4rem 1rem;
    }
    
    .mermaid:active {
      cursor: grabbing;
    }
    
    /* Zoom controls */
    .mermaid-zoom-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 5px;
      z-index: 1050;
    }
    
    .zoom-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      color: #333;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-width: 32px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    
    .zoom-btn:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .zoom-reset {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    
    .zoom-reset:hover {
      background: #0056b3;
      border-color: #0056b3;
    }
    
    .fullscreen-btn {
      background: #28a745;
      color: white;
      border-color: #28a745;
    }
    
    .fullscreen-btn:hover {
      background: #1e7e34;
      border-color: #1e7e34;
    }
    
    /* Zoom indicator */
    .zoom-indicator {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-family: monospace;
    }
    
    /* Fullscreen mode for Mermaid diagrams */
    .mermaid-diagram.fullscreen {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 99999 !important;
      background: white !important;
      padding: 20px !important;
      margin: 0 !important;
      border: none !important;
      overflow: auto !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    .mermaid-diagram.fullscreen .mermaid {
      max-width: 90vw !important;
      max-height: 90vh !important;
      width: auto !important;
      height: auto !important;
      display: block !important;
    }
    
    .mermaid-diagram.fullscreen .mermaid svg {
      max-width: 100% !important;
      max-height: 100% !important;
      width: auto !important;
      height: auto !important;
    }
    
    .mermaid-diagram.fullscreen .mermaid-zoom-controls {
      display: none !important;
    }
    
    .mermaid-diagram.fullscreen .zoom-indicator {
      display: none !important;
    }
    
    body.fullscreen-mode {
      overflow: hidden !important;
      background: white !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    /* Hide navigation bar when diagram is in fullscreen mode - especially important for mobile */
    body.fullscreen-mode .main-nav {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }
    
    .fullscreen-hidden {
      display: none !important;
    }
    
    /* Mobile responsive styles for Mermaid diagrams */
    @media (max-width: 768px) {
      .mermaid-diagram {
        margin: 0.75rem 0;
        padding: 0.5rem 0.75rem;
        /* Scroll margin to account for fixed navigation bar */
        scroll-margin-top: 100px;
        /* Remove max-height constraint to allow natural dimensions */
      }
      
      .mermaid-zoom-controls {
        top: 5px;
        right: 5px;
        gap: 3px;
      }
      
      .zoom-btn {
        padding: 4px 6px;
        font-size: 10px;
        min-width: 28px;
        height: 24px;
      }
      
      .zoom-indicator {
        bottom: 5px;
        left: 5px;
        padding: 2px 6px;
        font-size: 10px;
      }
      
      /* Fullscreen mobile adjustments */
      .mermaid-diagram.fullscreen {
        padding: 10px !important;
        /* Ensure fullscreen starts from very top on mobile */
        top: 0 !important;
      }
      
      .mermaid-diagram.fullscreen .mermaid {
        max-width: 95vw !important;
        max-height: 95vh !important;
      }
      
      /* Hide navigation bar on mobile when diagram is fullscreen */
      body.fullscreen-mode .main-nav {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        transform: translateY(-100%) !important;
      }
    }
    
    @media (max-width: 480px) {
      .mermaid-diagram {
        margin: 0.5rem 0;
        padding: 0.4rem 0.6rem;
        /* Scroll margin to account for fixed navigation bar */
        scroll-margin-top: 100px;
        /* Remove max-height constraint to allow natural dimensions */
      }
      
      .mermaid-zoom-controls {
        top: 3px;
        right: 3px;
        gap: 2px;
      }
      
      .zoom-btn {
        padding: 3px 5px;
        font-size: 9px;
        min-width: 24px;
        height: 20px;
      }
      
      .zoom-indicator {
        bottom: 3px;
        left: 3px;
        padding: 1px 4px;
        font-size: 9px;
      }
      
      /* Fullscreen mobile adjustments for very small screens */
      .mermaid-diagram.fullscreen {
        padding: 5px !important;
        /* Ensure fullscreen starts from very top on small mobile */
        top: 0 !important;
      }
      
      .mermaid-diagram.fullscreen .mermaid {
        max-width: 98vw !important;
        max-height: 98vh !important;
      }
      
      /* Hide navigation bar on small mobile when diagram is fullscreen */
      body.fullscreen-mode .main-nav {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        transform: translateY(-100%) !important;
      }
    }
  </style>
  
  <!-- Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
      <!-- X-Frame-Options should be set via HTTP headers, not meta tags -->
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="System Server: Best Practices and Optimization">
  <meta property="og:description" content="Development guidelines, threading best practices, memory management, and security considerations for system_server development.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://www.hemangpandhi.com/articles/android-system-server-best-practices.html">
  <meta property="og:image" content="https://www.hemangpandhi.com/assets/images/android_logo.PNG">
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="System Server: Best Practices and Optimization">
  <meta name="twitter:description" content="Development guidelines, threading best practices, memory management, and security considerations for system_server development.">
  <meta name="twitter:image" content="https://www.hemangpandhi.com/assets/images/android_logo.PNG">
</head>
<body>
  <!-- Navigation -->
  <nav class="main-nav">
    <div class="nav-container">
      <a href="../index.html" class="nav-logo-link">
        <img src="../assets/images/android_logo.PNG" alt="Android Internals Logo" class="nav-logo" />
      </a>
      <div class="nav-links" id="navLinks">
        <a href="../index.html" class="nav-link">Home</a>
        <a href="../index.html#topics" class="nav-link">Topics</a>
        <a href="../index.html#blogs" class="nav-link">Blogs</a>
        <a href="../index.html#about" class="nav-link">About</a>
        <a href="../books.html" class="nav-link">Reference Books</a>
        <a href="../videos.html" class="nav-link">Reference Videos</a>
      </div>
      <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle mobile menu">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
    </div>
  </nav>

  <!-- Article Header -->
  <header class="article-header">
    <div class="container">
      <div class="article-hero">
        <div class="article-meta">
          <span class="article-category">System Architecture</span>
          <span class="article-date">2025-10-04</span>
          <span class="article-read-time">5 min read</span>
        </div>
        <h1 class="article-title">System Server: Best Practices and Optimization</h1>
        <p class="article-subtitle">Development guidelines, threading best practices, memory management, and security considerations for system_server development.</p>
        <div class="article-author">
          <img src="../assets/images/android_logo.PNG" alt="Author" class="author-avatar">
          <div class="author-info">
            <span class="author-name">Android Internals Team</span>
            <span class="author-title">Android Internals Expert</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="article-content">
    <!-- Reading Mode Toggle -->
    <div class="reading-mode-controls">
      <button id="toggleReadingMode" class="reading-mode-btn">
        <span class="reading-mode-icon">üìñ</span>
        <span class="reading-mode-text">Full Screen</span>
      </button>
      <button id="toggleSidebar" class="sidebar-toggle-btn">
        <span class="sidebar-icon">üìã</span>
        <span class="sidebar-text">Sidebar</span>
      </button>
    </div>

    <div class="container">
      <div class="article-layout" id="articleLayout">
        <!-- Article Body -->
        <article class="article-body" id="articleBody">
          <div class="article-intro">
            <p class="lead-text">Development guidelines, threading best practices, memory management, and security considerations for system_server development.</p>
          </div>
          
          <div class="article-content-wrapper">
            <h1 id="-system--server--best--practices--and--optimization">System Server: Best Practices and Optimization</h1>


<h2 id="-learning--objectives">Learning Objectives</h2>

<blockquote class="article-quote"><p><strong>Part 5 of 6</strong> in the <a href="./android-system-server-series.html" class="article-link">Android System Server Deep Dive</a> series</p><p></p><p><strong>Previous</strong>: <a href="./android-system-server-debugging.html" class="article-link">Part 4: Debugging and Troubleshooting</a>  </p><p><strong>Next</strong>: <a href="./android-system-server-qa.html" class="article-link">Part 6: Advanced Q&amp;A</a>  </p><p><strong>Series Index</strong>: <a href="./android-system-server-series.html" class="article-link">View all articles</a></p></blockquote>
<p class="article-paragraph">By the end of this article, you will understand:</p>

<ul class="article-list"><li class="list-item"><strong>System Server Context</strong>: Service development, threading, memory management, and IPC optimization</li><li class="list-item"><strong>Application Context</strong>: Best practices for apps interacting with system_server, avoiding ANRs, and optimizing Binder calls</li><li class="list-item"><strong>Platform Context</strong>: Boot time optimization, resource management, and system-wide performance</li><li class="list-item"><strong>Security Context</strong>: SELinux policies, permission management, and security hardening</li><li class="list-item"><strong>Development Context</strong>: Code organization, testing strategies, and debugging practices</li><li class="list-item"><strong>Common Pitfalls</strong>: Real-world mistakes to avoid and how to prevent them</li></ul>
<hr class="article-divider">

<h2 id="-1--system--server--context--service--development--best--practices">1. System Server Context: Service Development Best Practices</h2>

<p class="article-paragraph">The system_server is the heart of Android, managing critical system services. Following best practices ensures stability, performance, and security. This section covers essential guidelines for developing system services.</p>

<h3 id="-11--threading--and--concurrency">1.1 Threading and Concurrency</h3>

<p class="article-paragraph"><strong>Critical Threading Rules:</strong></p>

<p class="article-paragraph">Threading is one of the most critical aspects of system_server development. Improper thread management can lead to deadlocks, ANRs, and system instability. Follow these rules religiously:</p>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Blocking I/O on main thread
   public void onTransact(int code, Parcel data, Parcel reply, int flags) {
       File file = new File(&quot;/data/system/config.txt&quot;);
       String content = Files.readString(file.toPath()); // BLOCKING!
       reply.writeString(content);
   }
   
   // ‚úÖ GOOD: Use background thread
   public void onTransact(int code, Parcel data, Parcel reply, int flags) {
       if (code == READ_CONFIG) {
           mHandler.post(() -&gt; {
               try {
                   File file = new File(&quot;/data/system/config.txt&quot;);
                   String content = Files.readString(file.toPath());
                   // Send result via callback or one-way transaction
               } catch (IOException e) {
                   // Handle error
               }
           });
           return true;
       }
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Dedicated HandlerThread for service operations
   public class MyService extends SystemService {
       private HandlerThread mHandlerThread;
       private Handler mHandler;
       
       @Override
       public void onStart() {
           mHandlerThread = new HandlerThread(&quot;MyServiceHandler&quot;);
           mHandlerThread.start();
           mHandler = new Handler(mHandlerThread.getLooper());
       }
       
       private void performBackgroundWork() {
           mHandler.post(() -&gt; {
               // Long-running operation
               processData();
           });
       }
   }</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Inconsistent lock ordering leads to deadlocks
   // Thread 1: lockA -&gt; lockB
   // Thread 2: lockB -&gt; lockA  // DEADLOCK!
   
   // ‚úÖ GOOD: Always acquire locks in same order
   private final Object mLockA = new Object();
   private final Object mLockB = new Object();
   
   private void method1() {
       synchronized (mLockA) {
           synchronized (mLockB) {
               // Critical section
           }
       }
   }
   
   private void method2() {
       synchronized (mLockA) {  // Same order!
           synchronized (mLockB) {
               // Critical section
           }
       }
   }</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Binder call while holding lock
   synchronized (mLock) {
       // Holding lock...
       mOtherService.doSomething(); // Binder call - can block!
       // Still holding lock - blocks other threads
   }
   
   // ‚úÖ GOOD: Release lock before Binder call
   SomeResult result;
   synchronized (mLock) {
       result = prepareData();
   }
   // Lock released
   mOtherService.doSomething(result); // Safe Binder call</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Optimize for read-heavy scenarios
   private final ReadWriteLock mCacheLock = new ReentrantReadWriteLock();
   private Map&lt;String, Data&gt; mCache = new HashMap&lt;&gt;();
   
   public Data getData(String key) {
       mCacheLock.readLock().lock();
       try {
           return mCache.get(key);
       } finally {
           mCacheLock.readLock().unlock();
       }
   }
   
   public void updateCache(String key, Data data) {
       mCacheLock.writeLock().lock();
       try {
           mCache.put(key, data);
       } finally {
           mCacheLock.writeLock().unlock();
       }
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Never Block Critical Threads:</strong></li><li class="list-item"><strong>Use HandlerThreads for Background Work:</strong></li><li class="list-item"><strong>Maintain Strict Lock Ordering:</strong></li><li class="list-item"><strong>Avoid Binder Calls While Holding Locks:</strong></li><li class="list-item"><strong>Use ReadWriteLock for Read-Heavy Operations:</strong></li></ol>
<h3 id="-12--memory--management">1.2 Memory Management</h3>

<p class="article-paragraph"><strong>Heap Management:</strong></p>

<p class="article-paragraph">Memory leaks in system_server can cause system-wide performance degradation and eventually lead to out-of-memory conditions. Proper memory management is essential for system stability.</p>

<div class="code-example">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">BASH</span>
                
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-bash"><span class="comment"># Regular monitoring</span>
   adb shell dumpsys meminfo system_server
   
   <span class="comment"># Track over time</span>
   watch -n 5 <span class="string">&quot;adb shell dumpsys meminfo system_server | head -30&quot;</span></code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Static reference to Activity/Context
   public class MyService {
       private static Activity sActivity; // LEAK!
   }
   
   // ‚úÖ GOOD: Use ApplicationContext or WeakReference
   public class MyService {
       private final Context mAppContext;
       
       public MyService(Context context) {
           mAppContext = context.getApplicationContext();
       }
   }
   
   // ‚úÖ GOOD: Use WeakReference for listeners
   private final List&lt;WeakReference&lt;Listener&gt;&gt; mListeners = new ArrayList&lt;&gt;();
   
   public void addListener(Listener listener) {
       mListeners.add(new WeakReference&lt;&gt;(listener));
   }
   
   private void notifyListeners() {
       Iterator&lt;WeakReference&lt;Listener&gt;&gt; it = mListeners.iterator();
       while (it.hasNext()) {
           WeakReference&lt;Listener&gt; ref = it.next();
           Listener listener = ref.get();
           if (listener == null) {
               it.remove(); // Clean up dead references
           } else {
               listener.onEvent();
           }
       }
   }</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Large transaction (&gt;1MB limit)
   public void sendLargeData(byte[] data) {
       Parcel parcel = Parcel.obtain();
       parcel.writeByteArray(data); // May exceed 1MB limit
       // Transaction fails!
   }
   
   // ‚úÖ GOOD: Split large data into chunks
   private static final int MAX_CHUNK_SIZE = 512 * 1024; // 512KB chunks
   
   public void sendLargeData(byte[] data) {
       int offset = 0;
       while (offset &lt; data.length) {
           int chunkSize = Math.min(MAX_CHUNK_SIZE, data.length - offset);
           byte[] chunk = Arrays.copyOfRange(data, offset, offset + chunkSize);
           sendChunk(chunk, offset, data.length);
           offset += chunkSize;
       }
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Reuse objects to reduce GC pressure
   private final Queue&lt;Parcel&gt; mParcelPool = new ConcurrentLinkedQueue&lt;&gt;();
   
   private Parcel obtainParcel() {
       Parcel parcel = mParcelPool.poll();
       if (parcel == null) {
           parcel = Parcel.obtain();
       }
       return parcel;
   }
   
   private void recycleParcel(Parcel parcel) {
       parcel.recycle();
       if (mParcelPool.size() &lt; 5) { // Limit pool size
           mParcelPool.offer(parcel);
       }
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Monitor Memory Growth:</strong></li><li class="list-item"><strong>Avoid Memory Leaks:</strong></li><li class="list-item"><strong>Respect Binder Transaction Limits:</strong></li><li class="list-item"><strong>Use Object Pools for Frequent Allocations:</strong></li></ol>
<h3 id="-13--binder--ipc--optimization">1.3 Binder IPC Optimization</h3>

<p class="article-paragraph"><strong>Transaction Optimization:</strong></p>

<p class="article-paragraph">Binder IPC is the primary communication mechanism in Android. Optimizing Binder transactions reduces latency, improves responsiveness, and prevents transaction buffer exhaustion. Every Binder call has overhead, so minimize unnecessary transactions.</p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: One-way transaction for notifications
   public void notifyEvent(Event event) {
       Parcel data = Parcel.obtain();
       Parcel reply = Parcel.obtain();
       try {
           event.writeToParcel(data, 0);
           // FLAG_ONEWAY: Don&#x27;t wait for reply
           transact(CODE_NOTIFY_EVENT, data, reply, IBinder.FLAG_ONEWAY);
       } finally {
           data.recycle();
           reply.recycle();
       }
   }</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Multiple separate transactions
   for (String item : items) {
       mService.processItem(item); // N transactions
   }
   
   // ‚úÖ GOOD: Batch in single transaction
   public void processItems(List&lt;String&gt; items) {
       Parcel data = Parcel.obtain();
       data.writeStringList(items); // Single transaction
       transact(CODE_PROCESS_ITEMS, data, null, 0);
       data.recycle();
   }</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Sending unnecessary data
   public void updateUser(User user) {
       Parcel data = Parcel.obtain();
       user.writeToParcel(data, 0); // Sends entire user object
       transact(CODE_UPDATE_USER, data, null, 0);
   }
   
   // ‚úÖ GOOD: Send only changed fields
   public void updateUserName(int userId, String name) {
       Parcel data = Parcel.obtain();
       data.writeInt(userId);
       data.writeString(name); // Only changed data
       transact(CODE_UPDATE_USER_NAME, data, null, 0);
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Async callback pattern
   public interface ResultCallback {
       void onResult(Result result);
       void onError(Error error);
   }
   
   public void performLongOperation(Params params, ResultCallback callback) {
       mHandler.post(() -&gt; {
           try {
               Result result = doLongWork(params);
               callback.onResult(result);
           } catch (Exception e) {
               callback.onError(new Error(e));
           }
       });
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Use One-Way Transactions for Fire-and-Forget:</strong></li><li class="list-item"><strong>Batch Multiple Operations:</strong></li><li class="list-item"><strong>Minimize Transaction Data Size:</strong></li><li class="list-item"><strong>Use Async Callbacks for Long Operations:</strong></li></ol>
<h3 id="-14--service--lifecycle--management">1.4 Service Lifecycle Management</h3>

<p class="article-paragraph"><strong>Startup Optimization:</strong></p>

<p class="article-paragraph">System services must start quickly during boot. Delayed service startup can significantly impact boot time. Optimize initialization to start critical services first and defer non-critical work.</p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Initialize heavy resources on-demand
   public class MyService extends SystemService {
       private HeavyResource mResource;
       
       public HeavyResource getResource() {
           if (mResource == null) {
               synchronized (this) {
                   if (mResource == null) {
                       mResource = new HeavyResource(); // Lazy init
                   }
               }
           }
           return mResource;
       }
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Defer non-critical initialization
   @Override
   public void onStart() {
       // Critical initialization
       initializeCore();
       
       // Defer heavy work
       mHandler.postDelayed(() -&gt; {
           initializeNonCritical();
       }, 5000); // 5 seconds after boot
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Clean up resources
   @Override
   public void onBootPhase(int phase) {
       if (phase == SystemService.PHASE_BOOT_COMPLETED) {
           // Cleanup temporary resources
           cleanupTempFiles();
       }
   }
   
   private void cleanupTempFiles() {
       File tempDir = new File(&quot;/data/system/temp&quot;);
       File[] files = tempDir.listFiles();
       if (files != null) {
           for (File file : files) {
               if (file.lastModified() &lt; System.currentTimeMillis() - 86400000) {
                   file.delete(); // Delete files older than 24 hours
               }
           }
       }
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Lazy Initialization:</strong></li><li class="list-item"><strong>Defer Non-Critical Work:</strong></li><li class="list-item"><strong>Proper Cleanup:</strong></li></ol>
<h2 id="-2--application--context--best--practices--for--apps">2. Application Context: Best Practices for Apps</h2>

<p class="article-paragraph">Applications interact with system_server through Binder IPC. Following best practices ensures smooth app performance and prevents ANRs. This section covers optimization techniques for app developers.</p>

<h3 id="-21--optimizing--binder--calls">2.1 Optimizing Binder Calls</h3>

<p class="article-paragraph"><strong>Minimize System Server Interactions:</strong></p>

<p class="article-paragraph">Every call to system_server involves Binder IPC overhead. Minimize these calls to improve app responsiveness and reduce system load.</p>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Getting service every time
   public void doSomething() {
       ActivityManager am = (ActivityManager) getSystemService(ACTIVITY_SERVICE);
       am.getRunningAppProcesses(); // Expensive call
   }
   
   // ‚úÖ GOOD: Cache service reference
   private ActivityManager mActivityManager;
   
   @Override
   public void onCreate() {
       super.onCreate();
       mActivityManager = (ActivityManager) getSystemService(ACTIVITY_SERVICE);
   }
   
   public void doSomething() {
       mActivityManager.getRunningAppProcesses(); // Reuse cached reference
   }</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Multiple separate calls
   for (String packageName : packages) {
       PackageManager pm = getPackageManager();
       pm.getApplicationInfo(packageName, 0); // N calls to system_server
   }
   
   // ‚úÖ GOOD: Batch operation if available
   PackageManager pm = getPackageManager();
   List&lt;ApplicationInfo&gt; infos = pm.getInstalledApplications(0);
   // Single call, filter locally</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Blocking call on main thread
   public void loadData() {
       List&lt;ProcessInfo&gt; processes = mActivityManager.getRunningAppProcesses();
       // Blocks main thread, can cause ANR
   }
   
   // ‚úÖ GOOD: Use async callback
   public void loadData() {
       new AsyncTask&lt;Void, Void, List&lt;ProcessInfo&gt;&gt;() {
           @Override
           protected List&lt;ProcessInfo&gt; doInBackground(Void... voids) {
               return mActivityManager.getRunningAppProcesses();
           }
           
           @Override
           protected void onPostExecute(List&lt;ProcessInfo&gt; processes) {
               updateUI(processes);
           }
       }.execute();
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Cache Service References:</strong></li><li class="list-item"><strong>Batch Multiple Calls:</strong></li><li class="list-item"><strong>Use Async APIs:</strong></li></ol>
<h3 id="-22--avoiding--anrs">2.2 Avoiding ANRs</h3>

<p class="article-paragraph"><strong>Best Practices:</strong></p>

<p class="article-paragraph">Application Not Responding (ANR) errors occur when the main thread is blocked for too long. ANRs severely impact user experience and can lead to app crashes. Follow these practices to prevent ANRs:</p>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Blocking on main thread
   @Override
   protected void onCreate(Bundle savedInstanceState) {
       super.onCreate(savedInstanceState);
       String data = loadDataFromNetwork(); // BLOCKS!
       displayData(data);
   }
   
   // ‚úÖ GOOD: Use background thread
   @Override
   protected void onCreate(Bundle savedInstanceState) {
       super.onCreate(savedInstanceState);
       new Thread(() -&gt; {
           String data = loadDataFromNetwork();
           runOnUiThread(() -&gt; displayData(data));
       }).start();
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Timeout for potentially slow operations
   private static final int TIMEOUT_MS = 5000;
   
   public void performOperation() {
       Handler handler = new Handler();
       Runnable timeoutRunnable = () -&gt; {
           // Handle timeout
           onTimeout();
       };
       handler.postDelayed(timeoutRunnable, TIMEOUT_MS);
       
       performAsyncOperation(() -&gt; {
           handler.removeCallbacks(timeoutRunnable);
           onSuccess();
       });
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: IntentService handles background work
   public class MyIntentService extends IntentService {
       public MyIntentService() {
           super(&quot;MyIntentService&quot;);
       }
       
       @Override
       protected void onHandleIntent(Intent intent) {
           // Long-running operation
           processData();
       }
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Never Block Main Thread:</strong></li><li class="list-item"><strong>Set Timeouts for System Calls:</strong></li><li class="list-item"><strong>Use IntentService for Long Operations:</strong></li></ol>
<h3 id="-23--memory--efficiency">2.3 Memory Efficiency</h3>

<p class="article-paragraph"><strong>Reduce Memory Pressure:</strong></p>

<p class="article-paragraph">Excessive memory usage by apps increases system pressure and can trigger low-memory conditions, causing the system to kill processes. Efficient memory management improves both app and system performance.</p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Release resources in onDestroy
   @Override
   protected void onDestroy() {
       super.onDestroy();
       if (mBitmap != null) {
           mBitmap.recycle();
           mBitmap = null;
       }
       if (mCursor != null) {
           mCursor.close();
       }
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Load data on-demand
   private List&lt;Item&gt; mItems;
   
   public List&lt;Item&gt; getItems() {
       if (mItems == null) {
           mItems = loadItems(); // Load only when needed
       }
       return mItems;
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Release Resources Promptly:</strong></li><li class="list-item"><strong>Use Lazy Loading:</strong></li></ol>
<h2 id="-3--platform--context--system--wide--optimization">3. Platform Context: System-Wide Optimization</h2>

<p class="article-paragraph">Platform-wide optimizations affect the entire Android system. These practices ensure efficient resource usage, fast boot times, and responsive system behavior.</p>

<h3 id="-31--boot--time--optimization">3.1 Boot Time Optimization</h3>

<p class="article-paragraph"><strong>Service Startup:</strong></p>

<p class="article-paragraph">Boot time is a critical user experience metric. Optimizing service startup reduces time-to-usable state and improves perceived performance. Follow these strategies:</p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Critical services in bootstrap phase
   private void startBootstrapServices(@NonNull TimingsTraceAndSlog t) {
       t.traceBegin(&quot;startBootstrapServices&quot;);
       
       // Critical: Start first
       mActivityManagerService = startService(ActivityManagerService.class);
       mPowerManagerService = startService(PowerManagerService.class);
       
       t.traceEnd(); // startBootstrapServices
   }
   
   private void startOtherServices(@NonNull TimingsTraceAndSlog t) {
       t.traceBegin(&quot;startOtherServices&quot;);
       
       // Non-critical: Start later
       mWallpaperService = startService(WallpaperService.class);
       
       t.traceEnd(); // startOtherServices
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Initialize independent services in parallel
   private void startCoreServices(@NonNull TimingsTraceAndSlog t) {
       t.traceBegin(&quot;startCoreServices&quot;);
       
       ExecutorService executor = Executors.newFixedThreadPool(4);
       
       executor.submit(() -&gt; startService(BatteryService.class));
       executor.submit(() -&gt; startService(UsageStatsService.class));
       executor.submit(() -&gt; startService(WebViewUpdateService.class));
       
       executor.shutdown();
       try {
           executor.awaitTermination(30, TimeUnit.SECONDS);
       } catch (InterruptedException e) {
           // Handle
       }
       
       t.traceEnd(); // startCoreServices
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Defer non-critical work
   @Override
   public void onBootPhase(int phase) {
       if (phase == SystemService.PHASE_BOOT_COMPLETED) {
           // Defer to avoid blocking boot
           mHandler.postDelayed(() -&gt; {
               initializeHeavyFeatures();
           }, 10000); // 10 seconds after boot complete
       }
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Prioritize Critical Services:</strong></li><li class="list-item"><strong>Parallel Service Initialization:</strong></li><li class="list-item"><strong>Defer Heavy Initialization:</strong></li></ol>
<h3 id="-32--resource--management">3.2 Resource Management</h3>

<p class="article-paragraph"><strong>CPU and Memory:</strong></p>

<p class="article-paragraph">System resources (CPU, memory, I/O) are finite. Proper resource management prevents resource exhaustion and ensures fair allocation across all processes.</p>

<div class="code-example">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">BASH</span>
                
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-bash"><span class="comment"># CPU monitoring</span>
   adb shell top -H -p $(pidof system_server)
   
   <span class="comment"># Memory monitoring</span>
   adb shell dumpsys meminfo system_server
   
   <span class="comment"># Set up alerts for high usage</span></code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Limit resource consumption
   private static final int MAX_CONCURRENT_OPERATIONS = 10;
   private final Semaphore mOperationSemaphore = new Semaphore(MAX_CONCURRENT_OPERATIONS);
   
   public void performOperation() {
       if (!mOperationSemaphore.tryAcquire()) {
           // Reject if too many concurrent operations
           throw new TooManyOperationsException();
       }
       try {
           doWork();
       } finally {
           mOperationSemaphore.release();
       }
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Monitor Resource Usage:</strong></li><li class="list-item"><strong>Implement Resource Limits:</strong></li></ol>
<h3 id="-33--performance--monitoring">3.3 Performance Monitoring</h3>

<p class="article-paragraph"><strong>Metrics Collection:</strong></p>

<p class="article-paragraph">Continuous performance monitoring helps identify regressions early and ensures optimal system performance. Track key metrics to maintain system health.</p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Monitor performance
   private void trackOperation(String operation, Runnable runnable) {
       long startTime = SystemClock.elapsedRealtime();
       try {
           runnable.run();
       } finally {
           long duration = SystemClock.elapsedRealtime() - startTime;
           if (duration &gt; 100) { // Log slow operations
               Slog.w(TAG, &quot;Slow operation: &quot; + operation + &quot; took &quot; + duration + &quot;ms&quot;);
           }
           mMetricsCollector.record(operation, duration);
       }
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Track Binder performance
   @Override
   public boolean onTransact(int code, Parcel data, Parcel reply, int flags) {
       long startTime = SystemClock.elapsedRealtime();
       try {
           boolean result = super.onTransact(code, data, reply, flags);
           return result;
       } finally {
           long duration = SystemClock.elapsedRealtime() - startTime;
           if (duration &gt; 50) { // Log slow transactions
               Slog.w(TAG, &quot;Slow transaction: code=&quot; + code + &quot; duration=&quot; + duration);
           }
       }
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Track Service Response Times:</strong></li><li class="list-item"><strong>Monitor Binder Transaction Latency:</strong></li></ol>
<h2 id="-4--security--context--hardening--best--practices">4. Security Context: Hardening Best Practices</h2>

<p class="article-paragraph">Security is paramount in system<em>server. A compromised system</em>server can lead to complete device compromise. Follow these security best practices to harden the system.</p>

<h3 id="-41--selinux--policies">4.1 SELinux Policies</h3>

<p class="article-paragraph"><strong>Policy Development:</strong></p>

<p class="article-paragraph">SELinux (Security-Enhanced Linux) provides mandatory access control. Proper SELinux policies restrict service capabilities and limit attack surface. Follow the principle of least privilege.</p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">BASH</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-bash"><span class="comment"># ‚úÖ GOOD: Proper domain transition</span>
   <span class="comment"># Allow system_server to execute binary in new domain</span>
   type_transition system_server, shell_exec, shell, shell;</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">BASH</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-bash"><span class="comment"># ‚ùå BAD: Overly permissive</span>
   allow system_server *:file { read write execute };
   
   <span class="comment"># ‚úÖ GOOD: Minimal permissions</span>
   allow system_server config_file:file { read };</code></pre>
          </div>

<div class="code-example">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">BASH</span>
                
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-bash"><span class="comment"># Check for denials</span>
   adb shell dmesg | <span class="keyword">grep</span> <span class="string">&quot;avc: denied&quot;</span>
   adb logcat | <span class="keyword">grep</span> <span class="string">&quot;SELinux&quot;</span>
   
   <span class="comment"># Generate policy from denials</span>
   adb shell audit2allow -p &lt;policy_file&gt; &lt; denial_log</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Understand Domain Transitions:</strong></li><li class="list-item"><strong>Minimize Permissions:</strong></li><li class="list-item"><strong>Monitor SELinux Denials:</strong></li></ol>
<h3 id="-42--permission--management">4.2 Permission Management</h3>

<p class="article-paragraph"><strong>Principle of Least Privilege:</strong></p>

<p class="article-paragraph">Always grant the minimum permissions necessary for functionality. Over-permissive services increase security risk. Verify permissions before performing sensitive operations.</p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Verify permissions
   public void performSensitiveOperation(int uid) {
       if (!hasPermission(uid, PERMISSION_SENSITIVE_OP)) {
           throw new SecurityException(&quot;Permission denied&quot;);
       }
       // Proceed with operation
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Check caller identity
   @Override
   public boolean onTransact(int code, Parcel data, Parcel reply, int flags) {
       if (code == SENSITIVE_OPERATION) {
           enforceCallingPermission(Manifest.permission.SENSITIVE_OP);
       }
       return super.onTransact(code, data, reply, flags);
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Check Permissions Before Operations:</strong></li><li class="list-item"><strong>Use Permission Checks in Binder:</strong></li></ol>
<h3 id="-43--input--validation">4.3 Input Validation</h3>

<p class="article-paragraph"><strong>Sanitize All Inputs:</strong></p>

<p class="article-paragraph">All input from untrusted sources (apps, network, files) must be validated and sanitized. Malicious input can lead to security vulnerabilities, crashes, or privilege escalation.</p>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: No validation
   public void processData(String data) {
       File file = new File(data); // Path traversal vulnerability!
   }
   
   // ‚úÖ GOOD: Validate input
   public void processData(String data) {
       // Validate path
       if (!isValidPath(data)) {
           throw new IllegalArgumentException(&quot;Invalid path&quot;);
       }
       // Sanitize
       String sanitized = sanitizePath(data);
       File file = new File(sanitized);
   }
   
   private boolean isValidPath(String path) {
       // Check for path traversal
       return !path.contains(&quot;..&quot;) &amp;&amp; path.startsWith(&quot;/data/system/&quot;);
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Bounds checking
   public void processArray(int[] array, int index) {
       if (index &lt; 0 || index &gt;= array.length) {
           throw new IndexOutOfBoundsException(&quot;Invalid index: &quot; + index);
       }
       // Safe to access
       int value = array[index];
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Validate Binder Input:</strong></li><li class="list-item"><strong>Validate Array Bounds:</strong></li></ol>
<h2 id="-5--development--context--code--quality">5. Development Context: Code Quality</h2>

<p class="article-paragraph">Maintainable, testable code is essential for long-term system health. This section covers code organization, testing strategies, and error handling best practices.</p>

<h3 id="-51--code--organization">5.1 Code Organization</h3>

<p class="article-paragraph"><strong>Service Structure:</strong></p>

<p class="article-paragraph">Well-organized code is easier to understand, test, and maintain. Follow these principles for clean service architecture:</p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Clear separation
   public class MyService extends SystemService {
       private final Handler mHandler;
       private final DataManager mDataManager;
       private final NetworkManager mNetworkManager;
       
       // Each component has single responsibility
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Testable design
   public class MyService extends SystemService {
       private final DataSource mDataSource;
       
       public MyService(Context context, DataSource dataSource) {
           super(context);
           mDataSource = dataSource; // Injected dependency
       }
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Separate Concerns:</strong></li><li class="list-item"><strong>Use Dependency Injection:</strong></li></ol>
<h3 id="-52--testing--strategies">5.2 Testing Strategies</h3>

<p class="article-paragraph"><strong>Comprehensive Testing Approach:</strong></p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Testable service methods
   public class MyService {
       private final DataSource mDataSource;
       
       public MyService(DataSource dataSource) {
           mDataSource = dataSource; // Dependency injection
       }
       
       public Result processData(Input input) {
           // Pure function - easy to test
           return doProcessing(input);
       }
   }
   
   // Unit test
   @Test
   public void testProcessData() {
       DataSource mockDataSource = mock(DataSource.class);
       MyService service = new MyService(mockDataSource);
       
       Input input = new Input(&quot;test&quot;);
       Result result = service.processData(input);
       
       assertEquals(&quot;expected&quot;, result.getValue());
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">BASH</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-bash"><span class="comment"># ‚úÖ GOOD: Test service interactions</span>
   <span class="comment"># Test service registration</span>
   adb shell service check activity
   
   <span class="comment"># Test service response</span>
   adb shell dumpsys activity services | <span class="keyword">grep</span> MyService
   
   <span class="comment"># Test Binder transactions</span>
   adb shell dumpsys activity services | <span class="keyword">grep</span> -A 10 <span class="string">&quot;Binder&quot;</span></code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">BASH</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-bash"><span class="comment"># ‚úÖ GOOD: Performance benchmarks</span>
   <span class="comment"># Baseline measurement</span>
   adb shell dumpsys meminfo system_server &gt; baseline.txt
   
   <span class="comment"># After changes</span>
   adb shell dumpsys meminfo system_server &gt; current.txt
   
   <span class="comment"># Compare</span>
   diff baseline.txt current.txt</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Unit Testing:</strong></li><li class="list-item"><strong>Integration Testing:</strong></li><li class="list-item"><strong>Performance Testing:</strong></li></ol>
<h3 id="-53--error--handling">5.3 Error Handling</h3>

<p class="article-paragraph"><strong>Robust Error Handling:</strong></p>

<p class="article-paragraph">System services must handle errors gracefully. Unhandled exceptions can crash system_server, causing system instability. Implement comprehensive error handling for all failure modes.</p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Comprehensive error handling
   public void performOperation() {
       try {
           doWork();
       } catch (IOException e) {
           Slog.e(TAG, &quot;IO error&quot;, e);
           // Recover gracefully
           recoverFromIOError();
       } catch (SecurityException e) {
           Slog.e(TAG, &quot;Security error&quot;, e);
           // Don&#x27;t expose sensitive info
           throw new RuntimeException(&quot;Operation failed&quot;);
       } catch (Exception e) {
           Slog.e(TAG, &quot;Unexpected error&quot;, e);
           // Log and continue if possible
       }
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: State validation
   public void performOperation() {
       if (!isInitialized()) {
           throw new IllegalStateException(&quot;Service not initialized&quot;);
       }
       if (isShuttingDown()) {
           throw new IllegalStateException(&quot;Service is shutting down&quot;);
       }
       // Proceed
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Handle All Exceptions:</strong></li><li class="list-item"><strong>Validate State:</strong></li></ol>
<h2 id="-6--common--pitfalls--and--how--to--avoid--them">6. Common Pitfalls and How to Avoid Them</h2>

<p class="article-paragraph">Even experienced developers make mistakes. This section highlights common pitfalls in system_server development and how to avoid them.</p>

<h3 id="-61--deadlock--prevention">6.1 Deadlock Prevention</h3>

<p class="article-paragraph"><strong>Common Deadlock Scenarios:</strong></p>

<p class="article-paragraph">Deadlocks occur when two or more threads are blocked waiting for each other. Deadlocks in system_server can cause system-wide hangs. Follow these patterns to prevent deadlocks:</p>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Potential deadlock
   // Thread 1: lockA -&gt; lockB
   // Thread 2: lockB -&gt; lockA
   
   // ‚úÖ GOOD: Consistent lock ordering
   // Always: lockA -&gt; lockB</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Deadlock risk
   synchronized (mLock) {
       mOtherService.call(); // Can block, holding lock
   }
   
   // ‚úÖ GOOD: Release lock first
   Data data;
   synchronized (mLock) {
       data = getData();
   }
   mOtherService.call(data);</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Lock Ordering Violations:</strong></li><li class="list-item"><strong>Binder Calls in Synchronized Blocks:</strong></li></ol>
<h3 id="-62--memory--leak--prevention">6.2 Memory Leak Prevention</h3>

<p class="article-paragraph"><strong>Common Leak Sources:</strong></p>

<p class="article-paragraph">Memory leaks gradually consume system memory, eventually leading to out-of-memory conditions. Common leak sources include static references, unregistered listeners, and retained contexts.</p>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Static reference leaks context
   private static Context sContext;
   
   // ‚úÖ GOOD: Use ApplicationContext
   private final Context mAppContext;</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Forgot to unregister
   mBroadcastReceiver = new BroadcastReceiver() { ... };
   registerReceiver(mBroadcastReceiver, filter);
   // Never unregistered!
   
   // ‚úÖ GOOD: Always unregister
   @Override
   protected void onDestroy() {
       if (mBroadcastReceiver != null) {
           unregisterReceiver(mBroadcastReceiver);
       }
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Static References:</strong></li><li class="list-item"><strong>Listener Registration:</strong></li></ol>
<h3 id="-63--performance--anti--patterns">6.3 Performance Anti-Patterns</h3>

<p class="article-paragraph"><strong>Avoid These Patterns:</strong></p>

<p class="article-paragraph">Some coding patterns seem reasonable but cause performance issues. Avoid these anti-patterns to maintain optimal system performance.</p>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Over-synchronization
   public synchronized void method1() { ... }
   public synchronized void method2() { ... }
   public synchronized void method3() { ... }
   
   // ‚úÖ GOOD: Minimize synchronization
   private final Object mLock = new Object();
   public void method1() {
       synchronized (mLock) {
           // Only critical section
       }
   }</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Complex optimization without profiling
   // ‚úÖ GOOD: Profile first, optimize hot paths</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Excessive Synchronization:</strong></li><li class="list-item"><strong>Premature Optimization:</strong></li></ol>
<h2 id="-7--additional--best--practices">7. Additional Best Practices</h2>

<h3 id="-71--logging--best--practices">7.1 Logging Best Practices</h3>

<p class="article-paragraph"><strong>Effective Logging:</strong></p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Appropriate log levels
   Slog.v(TAG, &quot;Detailed debug info&quot;); // Verbose - development only
   Slog.d(TAG, &quot;Debug information&quot;);   // Debug - development
   Slog.i(TAG, &quot;Informational message&quot;); // Info - important events
   Slog.w(TAG, &quot;Warning condition&quot;);    // Warning - potential issues
   Slog.e(TAG, &quot;Error occurred&quot;, exception); // Error - failures</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Logging sensitive information
   Slog.d(TAG, &quot;User password: &quot; + password);
   Slog.d(TAG, &quot;Auth token: &quot; + token);
   
   // ‚úÖ GOOD: Sanitize sensitive data
   Slog.d(TAG, &quot;User authentication attempted&quot;);
   Slog.d(TAG, &quot;Token length: &quot; + (token != null ? token.length() : 0));</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Structured logging for better analysis
   Slog.i(TAG, String.format(&quot;Service started: name=%s, pid=%d, uid=%d&quot;, 
       serviceName, Process.myPid(), Process.myUid()));</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Use Appropriate Log Levels:</strong></li><li class="list-item"><strong>Avoid Logging Sensitive Data:</strong></li><li class="list-item"><strong>Use Structured Logging:</strong></li></ol>
<h3 id="-72--error--recovery--strategies">7.2 Error Recovery Strategies</h3>

<p class="article-paragraph"><strong>Graceful Degradation:</strong></p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Fallback on failure
   public Data loadData() {
       try {
           return loadFromPrimarySource();
       } catch (IOException e) {
           Slog.w(TAG, &quot;Primary source failed, using cache&quot;, e);
           return loadFromCache();
       }
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Retry with backoff
   private static final int MAX_RETRIES = 3;
   private static final long INITIAL_DELAY_MS = 100;
   
   public void performOperationWithRetry() {
       int retries = 0;
       long delay = INITIAL_DELAY_MS;
       
       while (retries &lt; MAX_RETRIES) {
           try {
               performOperation();
               return; // Success
           } catch (TransientException e) {
               retries++;
               if (retries &lt; MAX_RETRIES) {
                   SystemClock.sleep(delay);
                   delay *= 2; // Exponential backoff
               }
           }
       }
       throw new OperationFailedException(&quot;Max retries exceeded&quot;);
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Implement Fallback Mechanisms:</strong></li><li class="list-item"><strong>Retry with Exponential Backoff:</strong></li></ol>
<h3 id="-73--testing--best--practices">7.3 Testing Best Practices</h3>

<p class="article-paragraph"><strong>Comprehensive Testing:</strong></p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Testable service design
   public class MyService {
       private final DataSource mDataSource;
       
       public MyService(DataSource dataSource) {
           mDataSource = dataSource; // Dependency injection
       }
       
       public Result processData(Input input) {
           // Pure logic - easy to test
           return doProcessing(input);
       }
   }
   
   // Unit test
   @Test
   public void testProcessData() {
       DataSource mockDataSource = mock(DataSource.class);
       MyService service = new MyService(mockDataSource);
       
       Input input = new Input(&quot;test&quot;);
       Result result = service.processData(input);
       
       assertEquals(&quot;expected&quot;, result.getValue());
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">BASH</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-bash"><span class="comment"># ‚úÖ GOOD: Test service interactions</span>
   <span class="comment"># Test service registration</span>
   adb shell service check activity
   
   <span class="comment"># Test service response</span>
   adb shell dumpsys activity services | <span class="keyword">grep</span> MyService
   
   <span class="comment"># Test Binder transactions</span>
   adb shell dumpsys activity services | <span class="keyword">grep</span> -A 10 <span class="string">&quot;Binder&quot;</span></code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">BASH</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-bash"><span class="comment"># ‚úÖ GOOD: Performance benchmarks</span>
   <span class="comment"># Baseline measurement</span>
   adb shell dumpsys meminfo system_server &gt; baseline.txt
   
   <span class="comment"># After changes</span>
   adb shell dumpsys meminfo system_server &gt; current.txt
   
   <span class="comment"># Compare</span>
   diff baseline.txt current.txt</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Unit Testing:</strong></li><li class="list-item"><strong>Integration Testing:</strong></li><li class="list-item"><strong>Performance Testing:</strong></li></ol>
<h3 id="-74--documentation--best--practices">7.4 Documentation Best Practices</h3>

<p class="article-paragraph"><strong>Clear Documentation:</strong></p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Clear, concise comments
   /**
    * Processes user data and returns result.
    * 
    * @param userId The unique identifier for the user
    * @param data The data to process
    * @return Processed result, or null if user not found
    * @throws SecurityException if caller lacks required permission
    */
   public Result processUserData(int userId, Data data) {
       // Implementation
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Document public APIs
   /**
    * System service for managing user data.
    * 
    * &lt;p&gt;This service provides secure access to user-specific data
    * stored in the system. All operations require appropriate
    * permissions and are subject to SELinux policies.
    * 
    * &lt;p&gt;Thread safety: This service is thread-safe. Multiple
    * concurrent calls are supported.
    */
   public class UserDataService extends SystemService {
       // ...
   }</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Code Comments:</strong></li><li class="list-item"><strong>API Documentation:</strong></li></ol>
<h3 id="-75--performance--optimization--checklist">7.5 Performance Optimization Checklist</h3>

<p class="article-paragraph"><strong>Before Optimization:</strong></p>

<div class="code-example">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">BASH</span>
                
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-bash"><span class="comment"># Use profiling tools</span>
   adb shell simpleperf record -p $(pidof system_server) -g --duration 30
   adb shell perfetto -o /data/local/tmp/trace.pbtxt -t 10s</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Profile First:</strong></li><li class="list-item"><strong>Identify Hot Paths:</strong></li></ol>

<ul class="article-list"><li class="list-item">Use profiling data to find slow operations</li><li class="list-item">Focus on frequently called methods</li><li class="list-item">Optimize critical paths first</li></ul>
<div class="code-example">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">BASH</span>
                
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-bash"><span class="comment"># Before optimization</span>
   adb shell dumpsys meminfo system_server &gt; before.txt
   
   <span class="comment"># After optimization</span>
   adb shell dumpsys meminfo system_server &gt; after.txt
   
   <span class="comment"># Compare results</span>
   diff before.txt after.txt</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Measure Impact:</strong></li></ol>
<p class="article-paragraph"><strong>Optimization Strategies:</strong></p>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Cache with TTL
   private final Map&lt;String, CachedData&gt; mCache = new ConcurrentHashMap&lt;&gt;();
   private static final long CACHE_TTL_MS = 60000; // 1 minute
   
   public Data getData(String key) {
       CachedData cached = mCache.get(key);
       if (cached != null &amp;&amp; 
           SystemClock.elapsedRealtime() - cached.timestamp &lt; CACHE_TTL_MS) {
           return cached.data;
       }
       
       Data data = loadData(key);
       mCache.put(key, new CachedData(data, SystemClock.elapsedRealtime()));
       return data;
   }</code></pre>
          </div>

<div class="code-example code-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-good">‚úÖ GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚úÖ GOOD: Initialize on demand
   private HeavyResource mResource;
   
   private HeavyResource getResource() {
       if (mResource == null) {
           synchronized (this) {
               if (mResource == null) {
                   mResource = new HeavyResource();
               }
           }
       }
       return mResource;
   }</code></pre>
          </div>

<div class="code-example code-bad-good">
            <div class="code-header">
              <div class="code-header-left">
                <span class="code-language">JAVA</span>
                <span class="code-badge code-badge-both">BAD vs GOOD</span>
              </div>
              <span class="code-copy" onclick="copyCode(this)">Copy</span>
            </div>
            <pre><code class="language-java">// ‚ùå BAD: Individual operations
   for (String item : items) {
       processItem(item); // N operations
   }
   
   // ‚úÖ GOOD: Batch processing
   processItems(items); // Single operation</code></pre>
          </div>

<ol class="article-list"><li class="list-item"><strong>Cache Frequently Accessed Data:</strong></li><li class="list-item"><strong>Use Lazy Initialization:</strong></li><li class="list-item"><strong>Batch Operations:</strong></li></ol>
<h2 id="-summary">Summary</h2>

<p class="article-paragraph">This comprehensive article covered best practices and optimization techniques across multiple contexts:</p>


<ol class="article-list"><li class="list-item"><strong>System Server Context</strong>: Threading, memory management, Binder optimization, service lifecycle</li><li class="list-item"><strong>Application Context</strong>: Optimizing Binder calls, avoiding ANRs, memory efficiency</li><li class="list-item"><strong>Platform Context</strong>: Boot time optimization, resource management, performance monitoring</li><li class="list-item"><strong>Security Context</strong>: SELinux policies, permission management, input validation</li><li class="list-item"><strong>Development Context</strong>: Code organization, testing, error handling</li><li class="list-item"><strong>Common Pitfalls</strong>: Deadlock prevention, memory leak avoidance, performance anti-patterns</li><li class="list-item"><strong>Additional Best Practices</strong>: Logging, error recovery, testing strategies, documentation, performance optimization checklist</li></ol>
<p class="article-paragraph"><strong>Key Takeaways:</strong></p>

<ul class="article-list"><li class="list-item">Always use background threads for I/O and long operations</li><li class="list-item">Maintain consistent lock ordering to prevent deadlocks</li><li class="list-item">Monitor memory usage and clean up resources promptly</li><li class="list-item">Optimize Binder transactions (batch, one-way, minimize size)</li><li class="list-item">Follow security best practices (SELinux, permissions, input validation)</li><li class="list-item">Profile before optimizing, focus on hot paths</li><li class="list-item">Write testable, maintainable code with proper error handling</li></ul>
<hr class="article-divider">

<h2 id="-next--steps">Next Steps</h2>

<p class="article-paragraph">Continue to <strong><a href="./android-system-server-qa.html" class="article-link">Part 6: Advanced Q&amp;amp;A</a></strong> for comprehensive answers to 25+ common questions about system_server, covering edge cases and advanced scenarios.</p>

<hr class="article-divider">

<h2 id="-related--articles">Related Articles</h2>


<ul class="article-list"><li class="list-item"><a href="./android-system-server-debugging.html" class="article-link">Part 4: Debugging and Troubleshooting</a></li><li class="list-item"><a href="./android-system-server-qa.html" class="article-link">Part 6: Advanced Q&amp;A</a></li><li class="list-item"><a href="./android-system-server-series.html" class="article-link">Series Index</a></li></ul>
<hr class="article-divider">

<p class="article-paragraph"><em>This article is part of the <a href="./android-system-server-series.html" class="article-link">Android System Server Deep Dive</a> series. For the complete learning path, start with the <a href="./android-system-server-series.html" class="article-link">Series Index</a>.</em></p>

          </div>
          
          <!-- Article Footer -->
          <div class="article-footer">
            <div class="article-tags">
              <span class="tag-label">Tags:</span>
              <span class="tag">Android</span>
              <span class="tag">Internals</span>
              <span class="tag">System Architecture</span>
            </div>
            <div class="article-share">
              <span class="share-label">Share:</span>
              <a href="https://twitter.com/intent/tweet?text=System Server: Best Practices and Optimization&url=https://www.hemangpandhi.com/articles/android-system-server-best-practices.html" target="_blank" class="share-link">üê¶ Twitter</a>
              <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.hemangpandhi.com/articles/android-system-server-best-practices.html" target="_blank" class="share-link">üíº LinkedIn</a>
            </div>
          </div>
        </article>

        <!-- Article Sidebar -->
        <aside class="article-sidebar" id="articleSidebar">
          <!-- Table of Contents -->
          <div class="sidebar-widget toc-widget">
            <h4>üìã Table of Contents</h4>
            <nav class="article-toc" id="tableOfContents">
              <ul>
                <li><a href="#introduction">Loading...</a></li>
              </ul>
            </nav>
          </div>

          <!-- Author Info -->
          <div class="sidebar-widget author-widget">
            <h4>üë§ About the Author</h4>
            <div class="author-card">
              <img src="../assets/images/android_logo.PNG" alt="Android Internals Team" class="author-avatar-small">
              <div class="author-details">
                <h5>Android Internals Team</h5>
                <p>Android Internals expert with deep knowledge of system architecture and development tools. Specializing in HAL, Framework, and system optimization.</p>
                <div class="author-stats">
                  <span class="stat">üìö 50+ Articles</span>
                  <span class="stat">üîß 10+ Years Experience</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Related Articles -->
          <div class="sidebar-widget related-widget">
            <h4>üîó Related Articles</h4>
            <div class="related-articles">
              <a href="../adb.html" class="related-article">
                <h5>ADB (Android Debug Bridge)</h5>
                <p>Powerful tool for Android development and debugging</p>
              </a>
              <a href="../hal.html" class="related-article">
                <h5>HAL (Hardware Abstraction Layer)</h5>
                <p>Bridging Android software and device hardware</p>
              </a>
              <a href="../framework.html" class="related-article">
                <h5>Android Framework</h5>
                <p>The backbone of Android app development</p>
              </a>
            </div>
          </div>

          <!-- Newsletter Signup -->
          <div class="sidebar-widget newsletter-widget">
            <h4>üìß Stay Updated</h4>
            <p>Get the latest Android Internals articles delivered to your inbox.</p>
            <form class="newsletter-form">
              <input type="email" placeholder="Enter your email" required>
              <button type="submit" class="btn btn-primary">Subscribe</button>
            </form>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <a href="../index.html" class="footer-logo-link">
            <img src="../assets/images/android_logo.PNG" alt="Android Internals Logo" class="footer-logo" />
          </a>
          <p>Comprehensive guide to Android OS architecture and internals.</p>
        </div>
        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="../hal.html">HAL</a></li>
            <li><a href="../framework.html">Framework</a></li>
            <li><a href="../adb.html">ADB</a></li>
            <li><a href="../books.html">Books</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Resources</h4>
          <ul>
            <li><a href="https://source.android.com" target="_blank">AOSP</a></li>
            <li><a href="https://developer.android.com" target="_blank">Android Dev</a></li>
            <li><a href="https://github.com" target="_blank">GitHub</a></li>
          </ul>
        </div>
      </div>
        <div class="footer-section">
          <h4>Legal</h4>
          <ul>
            <li><a href="../privacy.html">Privacy Policy</a></li>
            <li><a href="../terms.html">Terms of Service</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Android Internals. Not affiliated with Google or Android. Built with ‚ù§Ô∏è for the Android community.</p>
      </div>
    </div>
  </footer>

  <script src="../assets/js/scripts.js"></script>
  
  <!-- Cookie Consent Banner -->
  <div id="cookieConsentBanner" class="cookie-consent-banner">
    <div class="cookie-consent-content">
      <div class="cookie-consent-text">
        <p>We use cookies and service workers to enhance your browsing experience, analyze site traffic, and personalize content. By clicking "Accept", you consent to our use of cookies. <a href="../privacy.html">Learn more</a></p>
      </div>
      <div class="cookie-consent-buttons">
        <button id="cookieAcceptBtn" class="cookie-consent-btn cookie-consent-btn-accept">Accept</button>
        <button id="cookieDeclineBtn" class="cookie-consent-btn cookie-consent-btn-decline">Decline</button>
      </div>
    </div>
  </div>
  
  <script>
    // Redirect .md URLs to .html (for browser cache/history issues)
    (function() {
      const currentPath = window.location.pathname;
      if (currentPath.endsWith('.md')) {
        const newPath = currentPath.replace(/\.md$/, '.html');
        console.log('Redirecting .md URL to .html:', currentPath, '->', newPath);
        window.location.replace(newPath);
        return;
      }
    })();
    
    // Article functionality
    // Define functions globally first
    window.zoomDiagram = function(diagramId, factor) {
      const cleanId = diagramId.startsWith('mermaid-') ? diagramId : 'mermaid-' + diagramId;
      const diagram = document.getElementById(cleanId);
      const diagramContainer = document.getElementById('diagram-' + cleanId);
      const zoomIndicator = document.getElementById('zoom-' + diagramId);
      
      if (!diagram || !diagramContainer) return;
      
      // Initialize zoomLevels if not exists
      window.zoomLevels = window.zoomLevels || {};
      
      const currentZoom = window.zoomLevels[diagramId] || 1;
      const newZoom = Math.max(1, Math.min(5, currentZoom * factor)); // Start from 100% minimum
      window.zoomLevels[diagramId] = newZoom;
      
      // Apply zoom to the diagram element only
      diagram.style.transform = `scale(${newZoom})`;
      diagram.style.transformOrigin = 'top left';
      
      // Check if we're in fullscreen mode
      const isFullscreen = diagramContainer.style.position === 'fixed';
      if (isFullscreen) {
        // In fullscreen, preserve full height and enable scrolling
        diagramContainer.style.height = '100vh';
        diagramContainer.style.minHeight = '100vh';
        diagramContainer.style.maxHeight = 'none';
        diagramContainer.style.overflow = 'auto';
      } else {
        // Normal mode - ensure proper scrolling when zoomed
        if (newZoom > 1) {
          // When zoomed, ensure container allows horizontal and vertical scrolling
          diagramContainer.style.overflow = 'auto';
          diagramContainer.style.overflowX = 'auto';
          diagramContainer.style.overflowY = 'auto';
          diagramContainer.style.width = '100%';
          diagramContainer.style.maxWidth = '100%';
          diagramContainer.style.position = 'relative';
          diagramContainer.style.zIndex = '1040';
          diagramContainer.classList.add('zoomed');
          
          // Ensure the diagram element itself has proper width for scrolling
          const svg = diagram.querySelector('svg');
          if (svg) {
            // Get the natural SVG width (before scaling)
            const svgNaturalWidth = svg.viewBox.baseVal.width || svg.width.baseVal.value;
            if (svgNaturalWidth > 0) {
              // Set diagram width to accommodate scaled SVG
              const scaledWidth = svgNaturalWidth * newZoom;
              diagram.style.width = scaledWidth + 'px';
              diagram.style.minWidth = scaledWidth + 'px';
              diagram.style.maxWidth = 'none';
            } else {
              // Fallback: use bounding box if viewBox not available
              const svgWidth = svg.getBoundingClientRect().width;
              const scaledWidth = svgWidth * newZoom;
              diagram.style.width = scaledWidth + 'px';
              diagram.style.minWidth = scaledWidth + 'px';
              diagram.style.maxWidth = 'none';
            }
          }
        } else {
          // At 100% zoom, clear all styles to use natural dimensions
          diagramContainer.style.cssText = '';
          diagram.style.width = '';
          diagram.style.minWidth = '';
          diagram.style.maxWidth = '';
          diagramContainer.classList.remove('zoomed');
        }
      }
      
      if (zoomIndicator) {
        zoomIndicator.textContent = Math.round(newZoom * 100) + '%';
      }
    }
    
    window.resetZoom = function(diagramId) {
      const cleanId = diagramId.startsWith('mermaid-') ? diagramId : 'mermaid-' + diagramId;
      const diagram = document.getElementById(cleanId);
      const diagramContainer = document.getElementById('diagram-' + cleanId);
      const zoomIndicator = document.getElementById('zoom-' + diagramId);
      
      if (!diagram || !diagramContainer) return;
      
      // Reset zoom level
      window.zoomLevels = window.zoomLevels || {};
      window.zoomLevels[diagramId] = 1;
      
      // Remove zoomed class and z-index
      diagramContainer.classList.remove('zoomed');
      
      // Reset diagram to 100% scale
      diagram.style.transform = 'scale(1)';
      diagram.style.transformOrigin = 'top left';
      
      // Check if we're in fullscreen mode
      const isFullscreen = diagramContainer.style.position === 'fixed';
      if (isFullscreen) {
        // In fullscreen, preserve full height
        diagramContainer.style.height = '100vh';
        diagramContainer.style.minHeight = '100vh';
        diagramContainer.style.maxHeight = 'none';
        diagramContainer.style.overflow = 'auto';
      } else {
        // Normal mode - clear all styles exactly like fullscreen exit
        // This ensures the same behavior as exiting fullscreen mode
        diagramContainer.style.cssText = '';
        diagram.style.width = '';
        diagram.style.minWidth = '';
        diagram.style.maxWidth = '';
        const mermaidEl = diagramContainer.querySelector('.mermaid');
        if (mermaidEl) {
          mermaidEl.style.cssText = '';
        }
        const svgEl = mermaidEl?.querySelector('svg');
        if (svgEl) {
          svgEl.style.cssText = '';
        }
      }
      
      if (zoomIndicator) {
        zoomIndicator.textContent = '100%';
      }
    }
    
    window.toggleFullscreen = function(diagramId) {
      console.log('Fullscreen toggle called for:', diagramId);
      
      const container = document.getElementById(`diagram-${diagramId}`);
      if (!container) {
        console.error('Container not found:', `diagram-${diagramId}`);
        return;
      }
      
      const isFullscreen = container.style.position === 'fixed';
      
      if (isFullscreen) {
        // Exit fullscreen
        console.log('Exiting fullscreen');
        
        // Show navigation bar again
        const mainNav = document.querySelector('.main-nav');
        if (mainNav) {
          mainNav.style.display = '';
          mainNav.style.visibility = '';
          mainNav.style.opacity = '';
          mainNav.style.height = '';
          mainNav.style.overflow = '';
        }
        
        container.style.cssText = '';
        document.body.style.overflow = '';
        document.body.classList.remove('fullscreen-mode');
        
        // Reset the mermaid element styles to normal mode
        const mermaidEl = container.querySelector('.mermaid');
        if (mermaidEl) {
          mermaidEl.style.cssText = '';
        }
        
        // Reset the SVG element styles to normal mode
        const svgEl = mermaidEl?.querySelector('svg');
        if (svgEl) {
          svgEl.style.cssText = '';
        }
      } else {
        // Enter fullscreen
        console.log('Entering fullscreen');
        
        // Hide navigation bar explicitly (especially important for mobile)
        const mainNav = document.querySelector('.main-nav');
        if (mainNav) {
          mainNav.style.display = 'none';
          mainNav.style.visibility = 'hidden';
          mainNav.style.opacity = '0';
          mainNav.style.height = '0';
          mainNav.style.overflow = 'hidden';
        }
        
        container.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          min-height: 100vh !important;
          z-index: 999999 !important;
          background: white !important;
          display: block !important;
          padding: 10px !important;
          box-sizing: border-box !important;
          overflow: auto !important;
        `;
        
        const mermaidEl = container.querySelector('.mermaid');
        if (mermaidEl) {
          mermaidEl.style.cssText = `
            max-width: 95vw !important;
            max-height: 95vh !important;
            width: auto !important;
            height: auto !important;
            margin: 0 auto !important;
            display: block !important;
          `;
          
          // Also ensure the SVG inside uses full height
          const svgEl = mermaidEl.querySelector('svg');
          if (svgEl) {
            svgEl.style.cssText = `
              max-width: 95vw !important;
              max-height: 95vh !important;
              width: auto !important;
              height: auto !important;
            `;
          }
        }
        
        document.body.style.overflow = 'hidden';
        document.body.classList.add('fullscreen-mode');
      }
    }
    
    // Add escape key functionality
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        // Find any fullscreen diagram and exit it
        const fullscreenDiagram = document.querySelector('.mermaid-diagram[style*="position: fixed"]');
        if (fullscreenDiagram) {
          const diagramId = fullscreenDiagram.id.replace('diagram-', '');
          window.toggleFullscreen(diagramId);
        }
      }
    });
    
    // Initialize zoom levels storage
    window.zoomLevels = window.zoomLevels || {};
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded fired');
      console.log('Mermaid available:', typeof mermaid);
      
      // Initialize Mermaid with automatic rendering and minimal padding
      try {
        mermaid.initialize({
          startOnLoad: true,
          theme: 'default',
          securityLevel: 'loose',
          fontFamily: 'Arial, sans-serif',
          // Global settings for all diagram types
          useMaxWidth: true,
          // Flowchart settings - optimized for Mermaid 10.7.0
          // Critical: padding must be set to ensure viewBox includes all content
          flowchart: {
            padding: 20, // Increased padding to ensure all content is in viewBox
            useMaxWidth: true,
            htmlLabels: true,
            curve: 'basis',
            nodeSpacing: 50,
            rankSpacing: 50,
            wrap: false
          },
          // Sequence diagram settings
          sequence: {
            diagramMarginX: 10,
            diagramMarginY: 10,
            actorMargin: 50,
            width: 150,
            height: 65,
            boxMargin: 10,
            boxTextMargin: 5,
            noteMargin: 35,
            messageMargin: 35,
            mirrorActors: true,
            bottomMarginAdj: 1,
            useMaxWidth: true
          },
          // Class diagram settings
          class: {
            useMaxWidth: true,
            padding: 10
          },
          // State diagram settings
          state: {
            useMaxWidth: true,
            padding: 10
          },
          // Gantt chart settings
          gantt: {
            useMaxWidth: true
          },
          // Pie chart settings
          pie: {
            useMaxWidth: true
          },
          // Git graph settings
          gitGraph: {
            useMaxWidth: true
          },
          // ER diagram settings
          er: {
            useMaxWidth: true
          },
          // Journey diagram settings
          journey: {
            useMaxWidth: true
          },
          // C4 diagram settings
          c4: {
            useMaxWidth: true
          }
        });
        console.log('Mermaid initialized successfully');
        
        // Simple approach: Just ensure diagrams are properly displayed after Mermaid renders
        // Wait for Mermaid to render all diagrams, then ensure they're visible
        setTimeout(function() {
          console.log('Ensuring all diagrams are properly displayed');
          
          // Find all Mermaid diagrams
          const mermaidContainers = document.querySelectorAll('.mermaid-diagram');
          mermaidContainers.forEach(function(container) {
            const diagramId = container.id.replace('diagram-', '');
            const diagram = document.getElementById(diagramId);
            const zoomIndicator = document.getElementById('zoom-' + diagramId);
            
            if (diagram && container) {
              // Check if this is a sequence diagram
              const svg = container.querySelector('svg');
              let isSequenceDiagram = false;
              if (svg) {
                // Detect sequence diagrams
                const hasSequenceElements = svg.querySelector('g.actor, g.note, g.activation, g[class*="sequence"]');
                if (hasSequenceElements) {
                  isSequenceDiagram = true;
                  container.classList.add('sequence-diagram-container');
                }
              }
              
              // Initialize zoom level to 100%
              window.zoomLevels = window.zoomLevels || {};
              window.zoomLevels[diagramId] = 1;
              
              // Reset diagram to 100% scale
              diagram.style.transform = 'scale(1)';
              diagram.style.transformOrigin = 'top left';
              
              // CRITICAL FIX for Mermaid 10.7.0: Ensure container and SVG can display full content
              // Remove ALL height and overflow constraints
              container.style.cssText = `
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
                min-height: auto !important;
                margin: 1rem 0 !important;
                padding: 0.75rem 1rem !important;
                background: #f8f9fa !important;
                border-radius: 8px !important;
                border: 1px solid #e9ecef !important;
                position: relative !important;
                z-index: 1 !important;
              `;
              
              // CRITICAL FIX for Mermaid 10.7.0: Ensure SVG displays fully
              // Issue: Mermaid 10.7.0 may generate viewBox that cuts off content or has wrong aspect ratio
              if (svg) {
                // Use multiple attempts to ensure SVG is fully rendered
                function fixSvgDimensions() {
                  const viewBox = svg.viewBox.baseVal;
                  
                  if (viewBox && viewBox.width > 0 && viewBox.height > 0) {
                    // Remove any explicit width/height attributes that might conflict
                    // Let CSS handle sizing based on viewBox
                    svg.removeAttribute('width');
                    svg.removeAttribute('height');
                    
                    // Ensure preserveAspectRatio is set correctly
                    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                    
                    // Set styles to ensure full content is visible
                    // Use viewBox-based sizing (browser will calculate height from aspect ratio)
                    svg.style.cssText = `
                      display: block !important;
                      margin: 0 auto !important;
                      width: 100% !important;
                      max-width: 100% !important;
                      height: auto !important;
                      min-height: auto !important;
                      max-height: none !important;
                      overflow: visible !important;
                      box-sizing: border-box !important;
                    `;
                    
                    // Verify content is not cut off by checking bounding box
                    try {
                      const bbox = svg.getBBox();
                      if (bbox) {
                        // If content extends beyond viewBox, we need to expand it
                        const contentRight = bbox.x + bbox.width;
                        const contentBottom = bbox.y + bbox.height;
                        const viewBoxRight = viewBox.x + viewBox.width;
                        const viewBoxBottom = viewBox.y + viewBox.height;
                        
                        // If content is cut off, expand viewBox
                        if (contentRight > viewBoxRight || contentBottom > viewBoxBottom) {
                          const newX = Math.min(viewBox.x, bbox.x - 10);
                          const newY = Math.min(viewBox.y, bbox.y - 10);
                          const newWidth = Math.max(viewBox.width, contentRight - newX + 10);
                          const newHeight = Math.max(viewBox.height, contentBottom - newY + 10);
                          
                          svg.setAttribute('viewBox', `${newX} ${newY} ${newWidth} ${newHeight}`);
                          console.log('Expanded viewBox for', diagramId, 'to show full content');
                        }
                      }
                    } catch (e) {
                      // getBBox might fail if SVG is not fully rendered, that's OK
                    }
                  }
                }
                
                // Try immediately
                fixSvgDimensions();
                
                // Try again after a short delay (Mermaid might still be rendering)
                setTimeout(fixSvgDimensions, 100);
                setTimeout(fixSvgDimensions, 500);
              }
              
              // Also ensure the mermaid element itself doesn't constrain
              const mermaidEl = container.querySelector('.mermaid');
              if (mermaidEl) {
                mermaidEl.style.cssText = `
                  text-align: center !important;
                  display: block !important;
                  width: 100% !important;
                  height: auto !important;
                  max-height: none !important;
                  overflow: visible !important;
                  margin: 0 !important;
                  padding: 0 !important;
                `;
              }
              
              // Re-apply reduced padding for sequence diagrams
              if (isSequenceDiagram) {
                container.style.padding = '0.4rem 1rem';
              }
              
              // Update zoom indicator
              if (zoomIndicator) {
                zoomIndicator.textContent = '100%';
              }
            }
          });
        }, 1000); // Wait 1 second for Mermaid to finish rendering
        
      } catch (error) {
        console.error('Mermaid initialization failed:', error);
      }
      
      // Check if content is visible
      const contentWrapper = document.querySelector('.article-content-wrapper');
      console.log('Content wrapper found:', contentWrapper);
      if (contentWrapper) {
        console.log('Content wrapper visible:', contentWrapper.offsetHeight > 0);
        console.log('Content wrapper display:', window.getComputedStyle(contentWrapper).display);
      }
      
      // Reading mode toggle
      const toggleReadingMode = document.getElementById('toggleReadingMode');
      const toggleSidebar = document.getElementById('toggleSidebar');
      const articleLayout = document.getElementById('articleLayout');
      const articleSidebar = document.getElementById('articleSidebar');
      
      toggleReadingMode.addEventListener('click', function() {
        articleLayout.classList.toggle('full-screen');
        const isFullScreen = articleLayout.classList.contains('full-screen');
        
        if (isFullScreen) {
          toggleReadingMode.querySelector('.reading-mode-text').textContent = 'Exit Full Screen';
          articleSidebar.style.display = 'none';
        } else {
          toggleReadingMode.querySelector('.reading-mode-text').textContent = 'Full Screen';
          articleSidebar.style.display = 'block';
        }
      });
      
      toggleSidebar.addEventListener('click', function() {
        const isHidden = articleSidebar.style.display === 'none';
        articleSidebar.style.display = isHidden ? 'block' : 'none';
        toggleSidebar.querySelector('.sidebar-text').textContent = isHidden ? 'Hide Sidebar' : 'Show Sidebar';
      });
      
      // Generate Table of Contents
      function generateTOC() {
        const headings = document.querySelectorAll('.article-content-wrapper h1, .article-content-wrapper h2, .article-content-wrapper h3');
        const tocContainer = document.getElementById('tableOfContents');
        
        if (headings.length === 0) return;
        
        let tocHTML = '<ul>';
        headings.forEach((heading, index) => {
          const id = `heading-${index}`;
          heading.id = id;
          
          const level = parseInt(heading.tagName.charAt(1));
          const indent = level > 2 ? 'style="margin-left: ' + ((level - 2) * 20) + 'px;"' : '';
          
          tocHTML += `<li ${indent}><a href="#${id}">${heading.textContent}</a></li>`;
        });
        tocHTML += '</ul>';
        
        tocContainer.innerHTML = tocHTML;
      }
      
      // Smooth scrolling for TOC links
      function addSmoothScrolling() {
        document.querySelectorAll('.article-toc a').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
              target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
              });
            }
          });
        });
      }
      
      // Copy code functionality
      function addCopyCodeButtons() {
        document.querySelectorAll('.code-copy').forEach(button => {
          button.addEventListener('click', function() {
            const codeBlock = this.closest('.code-example').querySelector('code');
            const text = codeBlock.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
              this.textContent = 'Copied!';
              setTimeout(() => {
                this.textContent = 'Copy';
              }, 2000);
            });
          });
        });
      }
      
      // Initialize functionality
      generateTOC();
      setTimeout(() => {
        addSmoothScrolling();
        addCopyCodeButtons();
      }, 100);
    });

  </script>
</body>
</html> 