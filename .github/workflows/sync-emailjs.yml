name: Sync EmailJS Contacts

on:
  schedule:
    # Run every 6 hours to keep subscribers in sync
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    paths:
      - 'tools/sync-emailjs-contacts.js'
      - '.github/workflows/sync-emailjs.yml'
      - 'data/subscribers.json'

jobs:
  sync-contacts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Try EmailJS API Sync (Automatic)
        id: api_sync
        continue-on-error: true
        env:
          EMAILJS_PRIVATE_KEY: ${{ secrets.EMAILJS_PRIVATE_KEY }}
          EMAILJS_USER_ID: ${{ secrets.EMAILJS_PUBLIC_KEY }}
          EMAILJS_SERVICE_ID: ${{ secrets.EMAILJS_SERVICE_ID }}
        run: |
          echo "üîå Attempting to sync from EmailJS API (automatic)..."
          if [ -z "$EMAILJS_PRIVATE_KEY" ] || [ -z "$EMAILJS_USER_ID" ]; then
            echo "api_available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  EmailJS API credentials not configured"
            echo "üí° Set EMAILJS_PRIVATE_KEY and EMAILJS_PUBLIC_KEY in GitHub Secrets"
            echo "   Go to: https://github.com/hemangpandhi/android_internals/settings/secrets/actions"
          else
            echo "api_available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ EmailJS API credentials found - attempting API sync..."
            node tools/sync-emailjs-contacts.js || echo "api_failed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Fallback: Check for CSV file
        id: check_csv
        if: always()
        run: |
          # Check if API sync failed or wasn't available
          if [ "${{ steps.api_sync.outcome }}" == "failure" ] || [ "${{ steps.api_sync.outputs.api_available }}" != "true" ] || [ "${{ steps.api_sync.outputs.api_failed }}" == "true" ]; then
            if [ -f "emailjs-contacts.csv" ]; then
              echo "csv_exists=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Found emailjs-contacts.csv - will sync from CSV"
            else
              echo "csv_exists=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è  No CSV file found"
              echo ""
              echo "üìã To enable automatic sync:"
              echo "   Option 1 (Recommended): Set EmailJS API credentials in GitHub Secrets"
              echo "      - EMAILJS_PRIVATE_KEY (get from EmailJS Dashboard ‚Üí Account ‚Üí API Keys)"
              echo "      - EMAILJS_PUBLIC_KEY (your public key/user ID)"
              echo ""
              echo "   Option 2: Use CSV method"
              echo "      1. Go to EmailJS Dashboard ‚Üí Contacts"
              echo "      2. Click 'Export to CSV'"
              echo "      3. Save as 'emailjs-contacts.csv' in repository root"
              echo "      4. Commit and push the file"
            fi
          else
            echo "csv_exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ API sync succeeded - no CSV fallback needed"
          fi
      
      - name: Sync Contacts from CSV (Fallback)
        if: always() && steps.check_csv.outputs.csv_exists == 'true'
        env:
          EMAILJS_PRIVATE_KEY: ${{ secrets.EMAILJS_PRIVATE_KEY }}
          EMAILJS_SERVICE_ID: ${{ secrets.EMAILJS_SERVICE_ID }}
        run: |
          echo "üîÑ Syncing contacts from EmailJS CSV (fallback method)..."
          node tools/sync-emailjs-contacts.js emailjs-contacts.csv
          echo "‚úÖ Sync completed - subscribers.json updated"
      
      - name: No sync method available
        if: always() && steps.check_csv.outputs.csv_exists != 'true'
        run: |
          echo "‚ÑπÔ∏è  No automatic sync method available"
          echo "üìù Set up EmailJS API credentials OR add emailjs-contacts.csv file"
          echo "üí° Use newsletter admin panel CSV import for manual sync"
      
      - name: Commit and push changes
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/subscribers.json build/data/subscribers.json
          git diff --staged --quiet || git commit -m "Auto-sync: Update subscribers from EmailJS contacts [skip ci]"
          git push
        continue-on-error: true

